<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOVA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="logo.png?v=9">
    <link rel="apple-touch-icon" href="logo.png?v=9">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --gold: #D4AF37; --dark: #000000; --card-bg: #111; }
        body { 
            font-family: 'Montserrat', sans-serif; text-align: center; 
            background: var(--dark); color: var(--gold); 
            margin: 0; padding: 0; padding-bottom: 90px;
            -webkit-user-select: none; user-select: none; min-height: 100vh;
        }
        .container { width: 95%; max-width: 500px; margin: 20px auto; }
        .logo-img { width: 120px; margin-top: 20px; }
        .hidden { display: none !important; }

        /* KART STÄ°LLERÄ° */
        .card { 
            background: var(--card-bg); padding: 25px; border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.9); margin: 20px auto;
            border: 1px solid #333; position: relative; width: 90%; max-width: 380px;
        }
        h2 { color: var(--gold); margin-bottom: 10px; font-weight: 700; text-transform: uppercase; font-size: 18px;}
        input { 
            width: 100%; padding: 15px; margin: 10px 0; background: #222; border: 1px solid #444; 
            border-radius: 10px; box-sizing: border-box; font-size: 16px; color: #fff; outline: none; font-family: inherit;
        }
        input:focus { border-color: var(--gold); background: #2a2a2a; }
        
        .main-btn { 
            background: linear-gradient(45deg, var(--gold), #F2C94C); color: #000; border: none; padding: 16px; 
            border-radius: 10px; cursor: pointer; width: 100%; font-size: 16px; font-weight: 800; margin-top: 15px; text-transform: uppercase;
        }

        /* SÄ°PARÄ°Åž TAKÄ°P KUTUSU (YENÄ°) */
        .order-status-box {
            background: #222; border: 2px solid var(--gold); border-radius: 15px;
            padding: 15px; margin-bottom: 20px; text-align: left;
            animation: pulse 2s infinite; display: none; /* BaÅŸlangÄ±Ã§ta gizli */
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
        
        .status-title { font-size: 12px; color: #888; text-transform: uppercase; }
        .status-text { font-size: 18px; color: var(--gold); font-weight: bold; margin-top: 5px; }
        .status-time { font-size: 12px; color: #fff; margin-top: 5px; }

        /* MENÃœ VE SEPET */
        .cat-title { background: var(--gold); color: black; padding: 12px; margin: 20px 0 10px; border-radius: 8px; text-align: center; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;}
        .menu-card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 12px; text-align: left; }
        .menu-card h4 { color: #fff; margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .menu-item-btn { 
            background: transparent; border: 1px solid #444; color: #fff; 
            padding: 12px 5px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-align: center;
        }
        .menu-item-btn:active { background: var(--gold); color: black; border-color: var(--gold); }
        .price-tag { display: block; font-weight: bold; color: var(--gold); margin-top: 3px; }

        /* NAVÄ°GASYON */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #000; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 2000; padding-bottom: 10px; box-sizing: border-box;
        }
        .nav-item { color: #555; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; width: 50%; padding-top: 10px; cursor: pointer; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--gold); }

        .cart-bar { 
            position: fixed; bottom: 70px; left: 0; width: 100%; 
            background: #111; border-top: 2px solid var(--gold); 
            padding: 10px 20px; z-index: 1500; display: none; box-sizing: border-box;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .cart-flex { display: flex; justify-content: space-between; align-items: center; }
        .btn-wa { background: #25d366; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; overflow-y: auto; align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; width: 90%; max-width: 400px; margin: auto; padding: 20px; border-radius: 15px; border: 1px solid var(--gold); margin-top: 50px; margin-bottom: 50px;}
        .opt-item { display: flex; align-items: center; gap: 8px; background: #000; padding: 10px; border-radius: 6px; border: 1px solid #333; font-size: 0.8rem; cursor: pointer; color: #fff; margin-bottom:5px;}
        
        /* QR ALANI */
        #qrcode { display: flex; justify-content: center; margin: 20px 0; padding: 10px; background: white; border-radius: 10px; }
        #qrcode img { display: block; margin: auto; }
    </style>
</head>
<body>

    <img src="logo.png" alt="NOVA Logo" class="logo-img">

    <div id="tab-loyalty" class="container">
        <div class="card" id="auth-container">
            <h2 style="border-bottom: 1px solid #333; padding-bottom:10px;">Espace FidÃ©litÃ©</h2>
            <div id="login-form">
                <input type="tel" id="login-phone" placeholder="NumÃ©ro (ex: 0612345678)">
                <button class="main-btn" onclick="login()">Se Connecter</button>
                <p style="margin-top:15px; font-size:12px; cursor:pointer; text-decoration:underline;" onclick="switchAuth('register')">CrÃ©er une carte</p>
            </div>
            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Nom PrÃ©nom">
                <input type="tel" id="reg-phone" placeholder="TÃ©lÃ©phone">
                <button class="main-btn" onclick="register()">CrÃ©er</button>
                <p style="margin-top:15px; font-size:12px; cursor:pointer; text-decoration:underline;" onclick="switchAuth('login')">Retour connexion</p>
            </div>
        </div>

        <div class="card hidden" id="qr-container">
            <h2 id="welcomeMsg"></h2>
            <div id="qrcode"></div>
            <div style="background:#222; border-radius:10px; padding:10px;">
                <div style="display:flex; justify-content:space-between; color:#ccc; font-size:12px;"><span>Progression</span><span id="pointsRatio">0/10</span></div>
                <div style="width:100%; background:#444; height:10px; border-radius:5px; margin-top:5px;">
                    <div id="progressBar" style="height:100%; background:linear-gradient(90deg, var(--gold), #f1c40f); width:0%; border-radius:5px;"></div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top:15px;">
                <div style="flex:1; background:#000; padding:10px; border-radius:8px; border:1px solid #333;">
                    <span style="font-size:20px; color:var(--gold); font-weight:bold;" id="puanGoster">0</span><br><span style="font-size:10px; color:#888;">POINTS</span>
                </div>
                <div style="flex:1; background:#000; padding:10px; border-radius:8px; border:1px solid #333;">
                    <span style="font-size:20px; color:#fff; font-weight:bold;" id="harcananGoster">0</span><br><span style="font-size:10px; color:#888;">CADEAUX</span>
                </div>
            </div>
            <button onclick="logout()" style="background:none; border:none; color:#c0392b; font-size:12px; margin-top:20px;">DÃ©connexion</button>
        </div>
    </div>

    <div id="tab-menu" class="container hidden">
        
        <div id="orderStatusBox" class="order-status-box">
            <div class="status-title"><i class="fa-solid fa-spinner fa-spin"></i> Statut de la commande</div>
            <div class="status-text" id="statusText">En attente...</div>
            <div class="status-time" id="statusTime"></div>
        </div>

        <h2 style="margin-bottom:20px;">NOTRE CARTE</h2>

        <div class="cat-title">Les Assiettes</div>
        <div class="menu-card">
            <h4>Avec Bulgur, Frites, Salade</h4>
            <div class="menu-grid">
                <button class="menu-item-btn" onclick="openOp('Assiette Kebab', 13.00, 'plate')">Kebab<span class="price-tag">13â‚¬</span></button>
                <button class="menu-item-btn" onclick="openOp('Assiette Poulet', 14.00, 'plate')">Poulet<span class="price-tag">14â‚¬</span></button>
                <button class="menu-item-btn" onclick="openOp('Assiette Mixte', 17.50, 'plate')">Mixte<span class="price-tag">17.50â‚¬</span></button>
                </div>
        </div>

        <div class="cat-title">Les Tacos</div>
        <div class="menu-card">
            <h4>Sauce FromagÃ¨re Incluse</h4>
            <div class="menu-grid">
                <button class="menu-item-btn" onclick="openOp('Tacos 1 Viande', 8.00, 'tacos1')">1 Viande<span class="price-tag">8â‚¬</span></button>
                <button class="menu-item-btn" onclick="openOp('Tacos 2 Viandes', 9.50, 'tacos2')">2 Viandes<span class="price-tag">9.50â‚¬</span></button>
            </div>
        </div>

        <div style="height:50px;"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-loyalty" onclick="switchView('loyalty')"><i class="fa-solid fa-qrcode"></i><span>Ma Carte</span></div>
        <div class="nav-item" id="nav-menu" onclick="switchView('menu')"><i class="fa-solid fa-utensils"></i><span>Commander</span></div>
    </div>

    <div id="cartBar" class="cart-bar">
        <div class="cart-flex">
            <div style="text-align:left;">
                <span style="font-size:10px; color:#888;">TOTAL</span><br>
                <span class="total-price" id="totVal">0.00â‚¬</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="resetCart()" style="background:#444; color:#fff; border:none; border-radius:50%; width:30px; height:30px;"><i class="fa-solid fa-trash"></i></button>
                <button class="btn-wa" onclick="sendWA()"><i class="fa-brands fa-whatsapp"></i> Envoyer</button>
            </div>
        </div>
    </div>

    <div id="mDialog" class="modal">
        <div class="modal-content">
            <h3 id="mTitle" style="color:var(--gold); margin-bottom:15px;">Options</h3>
            <div id="viandeArea" style="display:none; text-align:left;">
                <label style="color:var(--gold); font-weight:bold;">Viandes :</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                    <label class="opt-item"><input type="checkbox" class="vc" value="Kebab"> Kebab</label>
                    <label class="opt-item"><input type="checkbox" class="vc" value="Poulet"> Poulet</label>
                    <label class="opt-item"><input type="checkbox" class="vc" value="Tenders"> Tenders</label>
                </div>
            </div>
            <div style="text-align:left; margin-top:15px;">
                <label style="color:var(--gold); font-weight:bold;">Sauces (Max 2) :</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
                    <label class="opt-item"><input type="checkbox" class="sc" value="Blanche"> Blanche</label>
                    <label class="opt-item"><input type="checkbox" class="sc" value="Algerienne"> Algerienne</label>
                    <label class="opt-item"><input type="checkbox" class="sc" value="Samourai"> Samourai</label>
                    <label class="opt-item"><input type="checkbox" class="sc" value="Biggy"> Biggy</label>
                </div>
            </div>
            <button class="main-btn" onclick="addItem()">AJOUTER</button>
            <button onclick="closeOp()" style="width:100%; background:none; color:#888; border:none; margin-top:15px;">Annuler</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxizNLOTlYYm7CUSRLDrMRe7Q1pn2l1D4",
            authDomain: "fidelite2-d521c.firebaseapp.com",
            projectId: "fidelite2-d521c",
            storageBucket: "fidelite2-d521c.firebasestorage.app",
            messagingSenderId: "787733255176",
            appId: "1:787733255176:web:df3a493d405f4b67b92dbd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });

        // --- TAKÄ°P SÄ°STEMÄ° ---
        function listenOrder(phone) {
            // Sadece 'TamamlandÄ±' (TerminÃ©) OLMAYAN sipariÅŸleri dinle
            db.collection("siparisler").doc(phone).onSnapshot((doc) => {
                const box = document.getElementById('orderStatusBox');
                if(doc.exists && doc.data().durum !== 'TerminÃ©') {
                    box.style.display = 'block';
                    const durum = doc.data().durum;
                    document.getElementById('statusText').innerText = durum;
                    
                    if(doc.data().teslimSaati) {
                        document.getElementById('statusTime').innerText = "Heure prÃ©vue : " + doc.data().teslimSaati;
                    } else {
                        document.getElementById('statusTime').innerText = "";
                    }

                    // HAZIR BÄ°LDÄ°RÄ°MÄ°
                    if(durum === 'PrÃªt' || durum === 'HazÄ±r') {
                        box.style.borderColor = '#2ecc71'; // YeÅŸil Ã§erÃ§eve
                        document.getElementById('statusText').style.color = '#2ecc71';
                        // TitreÅŸim (Android)
                        if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
                        alert("ðŸ½ï¸ VOTRE COMMANDE EST PRÃŠTE ! \nSipariÅŸiniz HazÄ±r!");
                    }
                } else {
                    box.style.display = 'none';
                }
            });
        }

        // --- MENÃœ Ä°ÅžLEMLERÄ° ---
        var sepet = [], suanki = null;
        function switchView(view) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-loyalty').classList.add('hidden');
            document.getElementById('tab-menu').classList.add('hidden');
            document.getElementById('cartBar').style.display = 'none';

            if(view === 'loyalty') {
                document.getElementById('tab-loyalty').classList.remove('hidden');
                document.getElementById('nav-loyalty').classList.add('active');
            } else {
                document.getElementById('tab-menu').classList.remove('hidden');
                document.getElementById('nav-menu').classList.add('active');
                if(sepet.length > 0) document.getElementById('cartBar').style.display = 'block';
            }
        }

        function openOp(n, p, t) {
            suanki = {n,p,t}; document.getElementById('mDialog').style.display = 'flex';
            document.getElementById('viandeArea').style.display = t.startsWith('tacos') ? 'block':'none';
            document.querySelectorAll('input[type=checkbox]').forEach(el=>el.checked=false);
        }
        function closeOp() { document.getElementById('mDialog').style.display = 'none'; }
        function addItem() {
            let v=[], s=[];
            document.querySelectorAll('.vc:checked').forEach(e=>v.push(e.value));
            document.querySelectorAll('.sc:checked').forEach(e=>s.push(e.value));
            if(suanki.t==='tacos1' && v.length>1) return alert("Max 1 Viande");
            if(suanki.t==='tacos2' && v.length>2) return alert("Max 2 Viandes");
            if(s.length>2) return alert("Max 2 Sauces");
            sepet.push({...suanki, v, s}); up(); closeOp();
        }
        function up() {
            let tot=sepet.reduce((a,b)=>a+b.p,0);
            document.getElementById('totVal').innerText=tot.toFixed(2)+"â‚¬";
            if(sepet.length>0) document.getElementById('cartBar').style.display='block';
        }
        function resetCart() { if(confirm("Vider?")) { sepet=[]; up(); document.getElementById('cartBar').style.display='none';}}

        // --- SÄ°PARÄ°ÅžÄ° GÃ–NDERME (DATABASE + WHATSAPP) ---
        function sendWA() {
            if(sepet.length===0) return;
            const phone = localStorage.getItem('nova_user_phone');
            
            // EÄŸer giriÅŸ yapmadÄ±ysa numara sor
            let finalPhone = phone;
            if(!finalPhone) {
                finalPhone = prompt("NumÃ©ro de tÃ©lÃ©phone pour le suivi :");
                if(!finalPhone) return alert("NumÃ©ro requis !");
                localStorage.setItem('nova_user_phone', finalPhone);
            }

            // 1. VeritabanÄ±na Kaydet
            let ozet = "";
            sepet.forEach((it,i) => {
                ozet += `${it.n}`;
                if(it.v && it.v.length) ozet += ` (${it.v.join(',')})`;
                if(it.s && it.s.length) ozet += ` [${it.s.join(',')}]`;
                ozet += "\n";
            });

            db.collection("siparisler").doc(finalPhone).set({
                musteriPhone: finalPhone,
                icerik: ozet,
                tutar: document.getElementById('totVal').innerText,
                durum: "En Attente", // Ä°lk durum: Bekliyor
                teslimSaati: "",
                tarih: new Date()
            }).then(() => {
                // Takibi BaÅŸlat
                listenOrder(finalPhone);

                // 2. WhatsApp'Ä± AÃ§
                let m = `*NOVA COMMANDE* (%2B Suivi App)%0AClient: ${finalPhone}%0A%0A`;
                sepet.forEach((it,i) => {
                    m += `${i+1}. ${it.n}`;
                    if(it.v && it.v.length) m += ` (${it.v.join(', ')})`;
                    if(it.s && it.s.length) m += ` - Sauces: ${it.s.join(', ')}`;
                    m += `%0A`;
                });
                m += `%0ATOTAL: ${document.getElementById('totVal').innerText}`;
                window.open("https://wa.me/33769428182?text=" + m, "_blank");
                
                // Sepeti temizle ve menÃ¼ye dÃ¶n
                sepet = []; up();
                alert("Commande envoyÃ©e ! Suivez le statut en haut du menu.");
            });
        }

        // --- GÄ°RÄ°Åž ---
        function login() {
            const p = document.getElementById('login-phone').value.replace(/\s/g,'');
            if(!p) return alert("NumÃ©ro?");
            db.collection("musteriler").doc(p).get().then(d=>{
                if(d.exists) openDash(d.data().ad, p, d.data().puan, d.data().harcanan||0);
                else { alert("Inconnu"); switchAuth('register'); document.getElementById('reg-phone').value=p;}
            });
        }
        function register() {
            const n=document.getElementById('reg-name').value, p=document.getElementById('reg-phone').value.replace(/\s/g,'');
            if(!n||!p) return alert("Info manquante");
            db.collection("musteriler").doc(p).set({ad:n, telefon:p, puan:0, harcanan:0, kayitTarihi:new Date()})
            .then(()=>openDash(n,p,0,0));
        }
        function openDash(n,p,pts,h) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('qr-container').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText="Bonjour "+n.split(' ')[0];
            document.getElementById('puanGoster').innerText=pts;
            document.getElementById('harcananGoster').innerText=h;
            let pc=(pts/10)*100; if(pc>100)pc=100;
            document.getElementById('progressBar').style.width=pc+"%";
            document.getElementById('pointsRatio').innerText=pts+"/10";
            document.getElementById('qrcode').innerHTML="";
            new QRCode(document.getElementById('qrcode'),{text:p,width:160,height:160});
            localStorage.setItem('nova_user_phone', p);
            
            // GiriÅŸ yapÄ±nca sipariÅŸ var mÄ± kontrol et
            listenOrder(p);
        }
        function switchAuth(t) {
            document.getElementById('login-form').className = t==='register'?'hidden':'';
            document.getElementById('register-form').className = t==='register'?'':'hidden';
        }
        function logout() { localStorage.removeItem('nova_user_phone'); location.reload(); }
        
        window.onload = function() {
            const saved = localStorage.getItem('nova_user_phone');
            if(saved) { document.getElementById('login-phone').value = saved; login(); }
        };
    </script>
</body>
</html>
