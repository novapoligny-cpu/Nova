<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA ADMIN (Full)</title>
    
    <link rel="manifest" href="admin-manifest.json">
    <link rel="icon" type="image/png" href="logo.png?v=9">
    <meta name="theme-color" content="#000000">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; background: #000; color: #fff; 
            margin:0; padding:10px; padding-bottom:50px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1, h2 { color: #D4AF37; text-align: center; text-transform: uppercase; }
        
        .card { 
            background: #111; border: 1px solid #333; padding: 15px; 
            border-radius: 10px; margin-bottom: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        input, textarea { 
            width: 100%; padding: 12px; margin: 5px 0 15px 0; 
            background: #222; border: 1px solid #444; color: white; 
            border-radius: 5px; box-sizing: border-box; outline:none; font-family: inherit;
        }
        input:focus { border-color: #D4AF37; }

        button { 
            cursor: pointer; border: none; border-radius: 5px; 
            font-weight: bold; padding: 12px; width: 100%; font-size:14px;
        }
        .btn-gold { background: #D4AF37; color: black; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-grey { background: #34495e; color: white; }
        
        /* Sƒ∞PARƒ∞≈û KARTLARI */
        .order-item { border-left: 4px solid #D4AF37; background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .order-header { display: flex; justify-content: space-between; font-size: 14px; color: #888; margin-bottom: 5px; }
        .order-content { font-size: 16px; margin-bottom: 10px; white-space: pre-line; }
        .order-actions { display: flex; gap: 5px; }
        .order-actions button { padding: 8px; font-size: 12px; }

        /* M√ú≈ûTERƒ∞ Lƒ∞STESƒ∞ */
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #1a1a1a; margin-bottom: 8px; padding: 12px; 
            border-radius: 8px; border-bottom: 1px solid #333;
        }
        .list-info { flex: 1; cursor: pointer; } 
        .add-point-btn { width: auto; padding: 5px 12px; font-size: 16px; margin-left: 10px; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #D4AF37; width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginScreen" style="text-align:center; padding-top:50px;">
        <h2 style="font-size: 24px;">NOVA ADMIN</h2>
        <input type="password" id="passInput" placeholder="Mot de passe" style="width: 200px; text-align: center;">
        <button onclick="checkPass()" class="btn-gold" style="width: 200px;">Connexion</button>
    </div>

    <div class="container" id="mainPanel" style="display:none;">
        
        <div class="card" style="border-color: #D4AF37;">
            <h2 style="margin-top:0;">üî• COMMANDES (Sipari≈üler)</h2>
            <div id="activeOrdersList">
                <p style="color:#555; text-align:center;">En attente de commande...</p>
            </div>
        </div>

        <div class="card">
            <h2>üì∑ SCANNER QR</h2>
            <div id="reader" style="width:100%;"></div>
            <button onclick="startCamera()" class="btn-gold" id="startBtn">D√âMARRER CAM√âRA</button>
            <button onclick="stopCamera()" class="btn-red" style="display:none;" id="stopBtn">ARR√äTER</button>
        </div>

        <div class="card">
            <h2>üë• CLIENTS & POINTS</h2>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="tel" id="manualPhone" placeholder="T√©l (ex: 0612...)" style="margin:0;">
                <button onclick="manualAdd()" class="btn-gold" style="width:auto;">OK</button>
            </div>

            <input type="text" id="searchBox" placeholder="üîç Rechercher un client..." onkeyup="filterList()">
            <div id="customerList" style="max-height: 400px; overflow-y: auto;"></div>
            
            <button onclick="openWhatsAppModal()" class="btn-green" style="margin-top:20px;">üì¢ Campagne WhatsApp</button>
        </div>

        <button onclick="location.reload()" class="btn-red" style="margin-top:20px;">D√©connexion</button>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Modifier Client</h3>
            <input type="text" id="editPhone" disabled style="color:#777;">
            <input type="text" id="editName" placeholder="Nom">
            <input type="text" id="editAddress" placeholder="Adresse">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="saveEdit()" class="btn-gold">Enregistrer</button>
                <button onclick="deleteCustomer()" class="btn-red">Supprimer</button>
            </div>
            <button onclick="closeModal('editModal')" class="btn-grey" style="margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="waModal" class="modal">
        <div class="modal-content">
            <h3>WhatsApp</h3>
            <textarea id="waMessage" rows="4" placeholder="Votre message..." onkeyup="renderWaList()"></textarea>
            <div id="waList" style="text-align:left; max-height:200px; overflow-y:auto; border:1px solid #333; padding:5px; margin-bottom:10px;"></div>
            <button onclick="closeModal('waModal')" class="btn-grey">Fermer</button>
        </div>
    </div>

    <script>
        // --- FIREBASE BAƒûLANTISI ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxizNLOTlYYm7CUSRLDrMRe7Q1pn2l1D4",
            authDomain: "fidelite2-d521c.firebaseapp.com",
            projectId: "fidelite2-d521c",
            storageBucket: "fidelite2-d521c.firebasestorage.app",
            messagingSenderId: "787733255176",
            appId: "1:787733255176:web:df3a493d405f4b67b92dbd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.settings({ experimentalForceLongPolling: true });

        let allCustomers = [];
        let html5QrCode;
        let currentEditPhone = null;

        function checkPass() {
            if(document.getElementById('passInput').value === "141017") {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainPanel').style.display = 'block';
                startListening();
            } else alert("Mot de passe incorrect");
        }

        function startListening() {
            listenOrders();
            listenCustomers();
        }

        // ============================
        // 1. Sƒ∞PARƒ∞≈û Sƒ∞STEMƒ∞ (YENƒ∞)
        // ============================
        function listenOrders() {
            db.collection("siparisler").where("durum", "!=", "Termin√©").onSnapshot(snap => {
                const list = document.getElementById('activeOrdersList');
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p style='color:#555; text-align:center;'>Aucune commande active.</p>"; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const color = (d.durum === 'Pr√™t' || d.durum === 'Hazƒ±r') ? '#2ecc71' : '#D4AF37';
                    
                    let html = `
                    <div class="order-item" style="border-left-color: ${color}">
                        <div class="order-header">
                            <span>üì± ${d.musteriPhone}</span>
                            <span style="color:${color}; font-weight:bold;">${d.durum}</span>
                        </div>
                        <div class="order-content">${d.icerik}</div>
                        <div style="font-weight:bold; margin-bottom:10px; color:#fff;">Total: ${d.tutar}</div>
                        <div class="order-actions">
                            <button onclick="setStatus('${doc.id}', 'En Pr√©paration')" style="background:#e67e22; color:white;">üç≥ Pr√©pa</button>
                            <button onclick="setStatus('${doc.id}', 'Pr√™t', true)" style="background:#2ecc71; color:white;">‚úÖ PR√äT</button>
                            <button onclick="askTime('${doc.id}')" style="background:#3498db; color:white;">‚è∞ Heure</button>
                            <button onclick="setStatus('${doc.id}', 'Termin√©')" style="background:#333; color:#aaa;">üóëÔ∏è Fin</button>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            });
        }

        function setStatus(id, status, isReady=false) {
            let data = { durum: status };
            if(isReady) data.teslimSaati = "MAINTENANT !";
            db.collection("siparisler").doc(id).update(data);
        }

        function askTime(id) {
            let t = prompt("Heure (ex: 19:30):");
            if(t) db.collection("siparisler").doc(id).update({ durum: "En Pr√©paration", teslimSaati: t });
        }

        // ============================
        // 2. M√ú≈ûTERƒ∞ Sƒ∞STEMƒ∞ (ESKƒ∞)
        // ============================
        function listenCustomers() {
            db.collection("musteriler").orderBy("kayitTarihi", "desc").onSnapshot(snap => {
                allCustomers = [];
                snap.forEach(doc => allCustomers.push(doc.data()));
                renderList(allCustomers);
            });
        }

        function renderList(data) {
            const listEl = document.getElementById('customerList');
            listEl.innerHTML = "";
            data.forEach(cust => {
                const color = cust.puan >= 10 ? '#D4AF37' : '#444';
                let html = `
                <div class="list-item" style="border-left: 4px solid ${color}">
                    <div class="list-info" onclick="openEdit('${cust.telefon}', '${cust.ad}', '${cust.adres||''}')">
                        <div style="font-weight:bold; color:#fff;">${cust.ad}</div>
                        <div style="font-size:12px; color:#888;">${cust.telefon}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span style="color:#D4AF37; font-weight:bold; margin-right:10px;">${cust.puan} ‚òÖ</span>
                        <button class="add-point-btn btn-green" onclick="addPoint('${cust.telefon}')">+</button>
                    </div>
                </div>`;
                listEl.innerHTML += html;
            });
        }

        function filterList() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            const filtered = allCustomers.filter(c => c.ad.toLowerCase().includes(term) || c.telefon.includes(term));
            renderList(filtered);
        }

        function manualAdd() {
            let phone = document.getElementById('manualPhone').value.replace(/\s/g,'');
            if(phone.length > 3) addPoint(phone);
        }

        function addPoint(phone) {
            const ref = db.collection("musteriler").doc(phone);
            ref.get().then(doc => {
                if(doc.exists) {
                    let np = (doc.data().puan || 0) + 1;
                    ref.update({ puan: np }).then(() => {
                        if(np >= 10) if(confirm(`üéâ ${doc.data().ad} a 10 points! Offrir cadeau?`)) {
                             ref.update({ puan: 0, harcanan: firebase.firestore.FieldValue.increment(1) });
                        }
                    });
                } else alert("Client introuvable !");
            });
            document.getElementById('manualPhone').value = "";
        }

        // ============================
        // 3. D√úZENLEME & MODALLAR
        // ============================
        function openEdit(phone, name, addr) {
            currentEditPhone = phone;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editName').value = name;
            document.getElementById('editAddress').value = addr;
            document.getElementById('editModal').style.display = 'flex';
        }
        function saveEdit() {
            db.collection("musteriler").doc(currentEditPhone).update({
                ad: document.getElementById('editName').value,
                adres: document.getElementById('editAddress').value
            });
            closeModal('editModal');
        }
        function deleteCustomer() {
            if(confirm("Supprimer d√©finitivement ?")) {
                db.collection("musteriler").doc(currentEditPhone).delete();
                closeModal('editModal');
            }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // ============================
        // 4. WHATSAPP & QR
        // ============================
        function openWhatsAppModal() { document.getElementById('waModal').style.display = 'flex'; renderWaList(); }
        function renderWaList() {
            const msg = encodeURIComponent(document.getElementById('waMessage').value);
            const div = document.getElementById('waList'); div.innerHTML = "";
            allCustomers.forEach(c => {
                let p = c.telefon.replace(/^0/, '33');
                div.innerHTML += `<div style="padding:5px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                    <span>${c.ad}</span> <a href="https://wa.me/${p}?text=${msg}" target="_blank" style="color:#25D366; text-decoration:none;">Envoyer ‚û§</a>
                </div>`;
            });
        }

        function startCamera() {
            if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            document.getElementById('startBtn').style.display='none';
            document.getElementById('stopBtn').style.display='block';
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
            (decodedText) => {
                html5QrCode.stop().then(() => {
                    document.getElementById('startBtn').style.display='block';
                    document.getElementById('stopBtn').style.display='none';
                    if(confirm("Ajouter point √† "+decodedText+"?")) addPoint(decodedText);
                });
            });
        }
        function stopCamera() {
            if(html5QrCode) html5QrCode.stop();
            document.getElementById('startBtn').style.display='block';
            document.getElementById('stopBtn').style.display='none';
        }
    </script>
</body>
</html>
