<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA ADMIN</title>
    <link rel="manifest" href="admin-manifest.json">
    <link rel="icon" type="image/png" href="logo.png?v=11">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #000; color: #fff; margin:0; padding:10px; padding-bottom:50px;}
        .container { max-width: 800px; margin: 0 auto; }
        h1, h2 { color: #D4AF37; text-align: center; text-transform: uppercase; }
        .card { background: #111; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        input, textarea { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; outline:none; font-family: inherit;}
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 12px; width: 100%; font-size:14px; }
        .btn-gold { background: #D4AF37; color: black; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #c0392b; color: white; }
        .btn-grey { background: #34495e; color: white; }
        
        .order-item { border-left: 4px solid #D4AF37; background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .order-header { display: flex; justify-content: space-between; font-size: 14px; color: #888; margin-bottom: 5px; }
        .order-content { font-size: 16px; margin-bottom: 10px; white-space: pre-line; }
        .order-actions { display: flex; gap: 5px; }
        .order-actions button { padding: 8px; font-size: 12px; }
        .new-order-alert { animation: flash 1s infinite; border: 2px solid red !important; }
        @keyframes flash { 0% { background-color: #111; } 50% { background-color: #440000; } 100% { background-color: #111; } }

        .list-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; margin-bottom: 8px; padding: 12px; border-radius: 8px; border-bottom: 1px solid #333;}
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #D4AF37; width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginScreen" style="text-align:center; padding-top:50px;">
        <h2>NOVA ADMIN</h2>
        <input type="password" id="passInput" placeholder="Mot de passe" style="width: 200px; text-align: center;">
        <button onclick="checkPass()" class="btn-gold" style="width: 200px;">Connexion</button>
    </div>

    <div class="container" id="mainPanel" style="display:none;">
        <div class="card" id="ordersCard" style="border-color: #D4AF37;">
            <h2 style="margin-top:0;">üî• COMMANDES</h2>
            <div id="activeOrdersList"><p style="color:#555; text-align:center;">Aucune commande.</p></div>
        </div>

        <div class="card">
            <h2>üì∑ SCANNER</h2>
            <div id="reader"></div>
            <button onclick="startCamera()" class="btn-gold" id="startBtn">D√âMARRER</button>
            <button onclick="stopCamera()" class="btn-red" style="display:none;" id="stopBtn">ARR√äTER</button>
        </div>

        <div class="card">
            <h2>üë• CLIENTS</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="tel" id="manualPhone" placeholder="06..." style="margin:0;">
                <button onclick="manualAdd()" class="btn-gold" style="width:auto;">OK</button>
            </div>
            <input type="text" id="searchBox" placeholder="üîç Rechercher..." onkeyup="filterList()">
            <div id="customerList" style="max-height: 400px; overflow-y: auto;"></div>
            <button onclick="openWhatsAppModal()" class="btn-green" style="margin-top:20px;">üì¢ WhatsApp</button>
        </div>
        <button onclick="location.reload()" class="btn-red" style="margin-top:20px;">D√©connexion</button>
    </div>

    <div id="editModal" class="modal"><div class="modal-content"><h3>Modifier</h3><input type="text" id="editPhone" disabled><input type="text" id="editName"><input type="text" id="editAddress"><div style="display:flex;gap:10px;"><button onclick="saveEdit()" class="btn-gold">Enregistrer</button><button onclick="deleteCustomer()" class="btn-red">Supprimer</button></div><button onclick="closeModal('editModal')" class="btn-grey" style="margin-top:10px;">Annuler</button></div></div>
    <div id="waModal" class="modal"><div class="modal-content"><h3>WhatsApp</h3><textarea id="waMessage" rows="4" onkeyup="renderWaList()"></textarea><div id="waList" style="text-align:left; max-height:200px; overflow-y:auto;"></div><button onclick="closeModal('waModal')" class="btn-grey">Fermer</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDxizNLOTlYYm7CUSRLDrMRe7Q1pn2l1D4", authDomain: "fidelite2-d521c.firebaseapp.com", projectId: "fidelite2-d521c", storageBucket: "fidelite2-d521c.firebasestorage.app", messagingSenderId: "787733255176", appId: "1:787733255176:web:df3a493d405f4b67b92dbd" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore(); db.settings({ experimentalForceLongPolling: true });
        
        // SES DOSYASI (Ding Sesi)
        const newOrderSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        
        let allCustomers=[], html5QrCode, currentEditPhone=null, firstLoad=true;

        function checkPass() { if(document.getElementById('passInput').value==="141017"){document.getElementById('loginScreen').style.display='none';document.getElementById('mainPanel').style.display='block';startListening();}else alert("Erreur"); }
        function startListening() { listenOrders(); listenCustomers(); }

        function listenOrders() {
            db.collection("siparisler").where("durum", "!=", "Termin√©").onSnapshot(snap => {
                const list = document.getElementById('activeOrdersList'); list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p style='color:#555; text-align:center;'>Aucune.</p>"; return; }
                
                // YENƒ∞ Sƒ∞PARƒ∞≈û KONTROL√ú (Sayfa ilk a√ßƒ±lƒ±≈üta √ßalmasƒ±n diye firstLoad kontrol√º)
                if(!firstLoad) {
                    snap.docChanges().forEach(change => {
                        if(change.type === "added") {
                            newOrderSound.play().catch(e=>console.log(e));
                            document.getElementById('ordersCard').classList.add('new-order-alert');
                            setTimeout(()=>document.getElementById('ordersCard').classList.remove('new-order-alert'), 3000);
                        }
                    });
                }
                firstLoad = false;

                snap.forEach(doc => {
                    const d = doc.data(); const color = (d.durum==='Pr√™t'||d.durum==='Hazƒ±r')?'#2ecc71':'#D4AF37';
                    list.innerHTML += `<div class="order-item" style="border-left-color: ${color}"><div class="order-header"><span>üì± ${d.musteriPhone}</span><span style="color:${color}; font-weight:bold;">${d.durum}</span></div><div class="order-content">${d.icerik}</div><div style="font-weight:bold; margin-bottom:10px;">${d.tutar}</div><div class="order-actions"><button onclick="setStatus('${doc.id}','En Pr√©paration')" style="background:#e67e22;color:white;">üç≥ Pr√©pa</button><button onclick="setStatus('${doc.id}','Pr√™t',true)" style="background:#2ecc71;color:white;">‚úÖ PR√äT</button><button onclick="askTime('${doc.id}')" style="background:#3498db;color:white;">‚è∞ Heure</button><button onclick="setStatus('${doc.id}','Termin√©')" style="background:#333;color:#aaa;">üóëÔ∏è Fin</button></div></div>`;
                });
            });
        }
        function setStatus(id,s,r=false) { let d={durum:s}; if(r) d.teslimSaati="MAINTENANT"; db.collection("siparisler").doc(id).update(d); }
        function askTime(id) { let t=prompt("Heure:"); if(t) db.collection("siparisler").doc(id).update({durum:"En Pr√©paration", teslimSaati:t}); }

        function listenCustomers() { db.collection("musteriler").orderBy("kayitTarihi","desc").onSnapshot(s=>{allCustomers=[];s.forEach(d=>allCustomers.push(d.data())); renderList(allCustomers);}); }
        function renderList(d) { const l=document.getElementById('customerList'); l.innerHTML=""; d.forEach(c=>{ let color=c.puan>=10?'#D4AF37':'#444'; l.innerHTML+=`<div class="list-item" style="border-left:4px solid ${color}"><div style="flex:1" onclick="openEdit('${c.telefon}','${c.ad}','${c.adres}')"><b>${c.ad}</b><br><small>${c.telefon}</small></div><div><span style="color:#D4AF37;font-weight:bold;margin-right:10px;">${c.puan}‚òÖ</span><button class="btn-green" style="width:auto;padding:5px 12px;" onclick="addPoint('${c.telefon}')">+</button></div></div>`; }); }
        function filterList() { const t=document.getElementById('searchBox').value.toLowerCase(); renderList(allCustomers.filter(c=>c.ad.toLowerCase().includes(t)||c.telefon.includes(t))); }
        function manualAdd() { let p=document.getElementById('manualPhone').value.replace(/\s/g,''); if(p.length>3) addPoint(p); }
        function addPoint(p) { db.collection("musteriler").doc(p).get().then(d=>{if(d.exists){let n=(d.data().puan||0)+1; db.collection("musteriler").doc(p).update({puan:n}).then(()=>{if(n>=10 && confirm(d.data().ad+" a 10 points! Cadeau?")) db.collection("musteriler").doc(p).update({puan:0,harcanan:firebase.firestore.FieldValue.increment(1)});});}else alert("Inconnu");}); document.getElementById('manualPhone').value=""; }

        function openEdit(p,n,a) { currentEditPhone=p; document.getElementById('editPhone').value=p; document.getElementById('editName').value=n; document.getElementById('editAddress').value=a; document.getElementById('editModal').style.display='flex'; }
        function saveEdit() { db.collection("musteriler").doc(currentEditPhone).update({ad:document.getElementById('editName').value, adres:document.getElementById('editAddress').value}); closeModal('editModal'); }
        function deleteCustomer() { if(confirm("Supprimer?")) {db.collection("musteriler").doc(currentEditPhone).delete(); closeModal('editModal');} }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function openWhatsAppModal() { document.getElementById('waModal').style.display='flex'; renderWaList(); }
        function renderWaList() { const m=encodeURIComponent(document.getElementById('waMessage').value); const l=document.getElementById('waList'); l.innerHTML=""; allCustomers.forEach(c=>{ let p=c.telefon.replace(/^0/,'33'); l.innerHTML+=`<div style="padding:5px;border-bottom:1px solid #333;display:flex;justify-content:space-between;"><span>${c.ad}</span><a href="https://wa.me/${p}?text=${m}" target="_blank" style="color:#25D366;text-decoration:none;">Envoyer ‚û§</a></div>`; }); }

        function startCamera() { if(!html5QrCode) html5QrCode=new Html5Qrcode("reader"); document.getElementById('startBtn').style.display='none'; document.getElementById('stopBtn').style.display='block'; html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},(t)=>{html5QrCode.stop().then(()=>{document.getElementById('startBtn').style.display='block';document.getElementById('stopBtn').style.display='none';if(confirm("Ajouter point √† "+t+"?")) addPoint(t);});}); }
        function stopCamera() { if(html5QrCode) html5QrCode.stop(); document.getElementById('startBtn').style.display='block'; document.getElementById('stopBtn').style.display='none'; }
    </script>
</body>
</html>
