<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA ADMIN</title>
    <link rel="manifest" href="admin-manifest.json">
    <link rel="icon" type="image/png" href="logo.png?v=9">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #000; color: #fff; margin:0; padding:10px; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 50px;}
        h1 { color: #D4AF37; text-align: center; }
        .card { background: #111; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 10px; }
        .btn-gold { background: #D4AF37; color: black; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #c0392b; color: white; }
        
        /* Sƒ∞PARƒ∞≈û KARTLARI */
        .order-item { border-left: 4px solid #D4AF37; background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .order-header { display: flex; justify-content: space-between; font-size: 14px; color: #888; margin-bottom: 5px; }
        .order-content { font-size: 16px; margin-bottom: 10px; white-space: pre-line; }
        .order-actions { display: flex; gap: 5px; overflow-x: auto; }
        .order-actions button { flex: 1; font-size: 12px; }
    </style>
</head>
<body>
    <div id="loginScreen" style="text-align:center; padding-top:50px;">
        <h2>ADMIN LOGIN</h2>
        <input type="password" id="passInput" placeholder="Password" style="padding:10px; font-size:18px;">
        <button onclick="checkPass()" class="btn-gold">Entrer</button>
    </div>

    <div class="container" id="mainPanel" style="display:none;">
        <h1>Panneau Admin</h1>

        <div class="card" style="border-color: #D4AF37;">
            <h2 style="color:#D4AF37; margin-top:0;">üî• COMMANDES EN COURS (Sipari≈üler)</h2>
            <div id="activeOrdersList">
                <p style="color:#555;">Aucune commande active...</p>
            </div>
        </div>

        <div class="card">
            <h2>üì∑ SCANNER QR</h2>
            <div id="reader" style="width:100%;"></div>
            <button onclick="startCamera()" class="btn-gold" style="width:100%; margin-top:10px;">SCANNER</button>
            <button onclick="stopCamera()" class="btn-red" style="width:100%; margin-top:5px; display:none;" id="stopBtn">ARR√äTER</button>
        </div>
        
        <button onclick="location.reload()" class="btn-red" style="width:100%; margin-top:20px;">D√©connexion</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxizNLOTlYYm7CUSRLDrMRe7Q1pn2l1D4",
            authDomain: "fidelite2-d521c.firebaseapp.com",
            projectId: "fidelite2-d521c",
            storageBucket: "fidelite2-d521c.firebasestorage.app",
            messagingSenderId: "787733255176",
            appId: "1:787733255176:web:df3a493d405f4b67b92dbd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let html5QrCode;

        function checkPass() {
            if(document.getElementById('passInput').value === "1234") {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainPanel').style.display = 'block';
                listenOrders();
            } else alert("Erreur");
        }

        // --- Sƒ∞PARƒ∞≈ûLERƒ∞ Dƒ∞NLE ---
        function listenOrders() {
            db.collection("siparisler").where("durum", "!=", "Termin√©").onSnapshot(snap => {
                const list = document.getElementById('activeOrdersList');
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p style='color:#555;'>Aucune commande.</p>"; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const color = d.durum === 'Pr√™t' ? '#2ecc71' : '#D4AF37';
                    
                    let html = `
                    <div class="order-item" style="border-left-color: ${color}">
                        <div class="order-header">
                            <span>üì± ${d.musteriPhone}</span>
                            <span style="color:${color}; font-weight:bold;">${d.durum}</span>
                        </div>
                        <div class="order-content">${d.icerik}</div>
                        <div style="font-weight:bold; margin-bottom:10px; color:#fff;">Total: ${d.tutar}</div>
                        
                        <div class="order-actions">
                            <button onclick="setStatus('${doc.id}', 'En Pr√©paration')" style="background:#e67e22; color:white;">üç≥ Pr√©pa</button>
                            <button onclick="setStatus('${doc.id}', 'Pr√™t', true)" style="background:#2ecc71; color:white;">‚úÖ PR√äT (HAZIR)</button>
                            <button onclick="askTime('${doc.id}')" style="background:#3498db; color:white;">‚è∞ Heure</button>
                            <button onclick="setStatus('${doc.id}', 'Termin√©')" style="background:#333; color:#aaa;">üóëÔ∏è Fin</button>
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            });
        }

        function setStatus(id, status, isReady=false) {
            let updateData = { durum: status };
            if(isReady) updateData.teslimSaati = "MAINTENANT (≈ûimdi)";
            
            db.collection("siparisler").doc(id).update(updateData);
        }

        function askTime(id) {
            let time = prompt("Heure de pr√™t (ex: 19:30):");
            if(time) {
                db.collection("siparisler").doc(id).update({
                    durum: "En Pr√©paration",
                    teslimSaati: time
                });
            }
        }

        // --- KAMERA QR ---
        function startCamera() {
            if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
            (decodedText) => {
                // QR Okundu, puan ekle
                if(confirm("Ajouter 1 point √† " + decodedText + "?")) {
                    db.collection("musteriler").doc(decodedText).update({
                        puan: firebase.firestore.FieldValue.increment(1)
                    }).then(()=>alert("Point ajout√©!"));
                }
                stopCamera();
            });
            document.getElementById('stopBtn').style.display = 'block';
        }
        function stopCamera() {
             if(html5QrCode) html5QrCode.stop().then(()=>{
                 document.getElementById('stopBtn').style.display = 'none';
             });
        }
    </script>
</body>
</html>
